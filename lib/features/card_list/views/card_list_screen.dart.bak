import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:house_note/data/models/card_model.dart';
import 'package:house_note/data/models/user_model.dart';
import 'package:house_note/providers/card_providers.dart';
import 'package:house_note/providers/auth_providers.dart';
import 'package:house_note/providers/user_providers.dart';
import 'package:house_note/features/card_list/views/property_detail_screen.dart';
import 'package:house_note/data/models/property_chart_model.dart';
import 'package:house_note/providers/property_chart_providers.dart';

class CardListScreen extends ConsumerStatefulWidget {
  static const routeName = 'card-list';
  static const routePath = '/cards';

  const CardListScreen({super.key});

  @override
  ConsumerState<CardListScreen> createState() => _CardListScreenState();
}

class _CardListScreenState extends ConsumerState<CardListScreen> {
  final TextEditingController _searchController = TextEditingController();
  String _selectedSort = 'ìµœì‹ ìˆœ'; // ê¸°ë³¸ ì •ë ¬ ë°©ì‹
  String? _selectedChartId; // ì„ íƒëœ ì°¨íŠ¸ ID
  List<String> _customSortOptions = ['ìµœì‹ ìˆœ', 'ê±°ë¦¬ìˆœ', 'ì›”ì„¸ìˆœ']; // ì‚¬ìš©ì ì •ì˜ ì •ë ¬ ì˜µì…˜

  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final userId = ref.watch(authStateChangesProvider).asData?.value?.uid;

    return Scaffold(
      backgroundColor: Colors.grey[50],
      appBar: AppBar(
        title: const Text('ì¹´ë“œ ëª©ë¡',
            style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
        backgroundColor: const Color(0xFFFF8A65),
        centerTitle: true,
        elevation: 0,
      ),
      body: Column(
        children: [
          // ê²€ìƒ‰ ë°” ë° í•„í„° ì˜ì—­
          Container(
            padding: const EdgeInsets.all(16.0),
            color: Colors.white,
            child: Column(
              children: [
                // ê²€ìƒ‰ ë°”
                Row(
                  children: [
                    Expanded(
                      child: Container(
                        height: 48,
                        decoration: BoxDecoration(
                          color: Colors.grey[100],
                          borderRadius: BorderRadius.circular(24),
                        ),
                        child: TextField(
                          controller: _searchController,
                          decoration: const InputDecoration(
                            hintText: 'ì§€ì—­, ê°€ê²©ìœ¼ë¡œ ê²€ìƒ‰...',
                            prefixIcon: Icon(Icons.search, color: Colors.grey),
                            border: InputBorder.none,
                            contentPadding: EdgeInsets.symmetric(
                                horizontal: 16, vertical: 12),
                          ),
                          onChanged: (value) {
                            // TODO: ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„
                          },
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Container(
                      height: 48,
                      width: 48,
                      decoration: BoxDecoration(
                        color: Colors.grey[200],
                        borderRadius: BorderRadius.circular(24),
                      ),
                      child: const Icon(Icons.add, color: Colors.grey),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                // í•„í„° ë²„íŠ¼ë“¤
                Row(
                  children: [
                    // ì°¨íŠ¸ ì„ íƒ ë“œë¡­ë‹¤ìš´
                    Consumer(
                      builder: (context, ref, child) {
                        final chartList = ref.watch(propertyChartListProvider);
                        return DropdownButton<String?>(
                          value: _selectedChartId,
                          hint: const Text('ëª¨ë“  ì°¨íŠ¸', style: TextStyle(fontSize: 14)),
                          items: [
                            DropdownMenuItem<String?>(
                              value: null,
                              child: const Text('ëª¨ë“  ì°¨íŠ¸'),
                            ),
                            ...chartList.map((chart) => DropdownMenuItem<String>(
                              value: chart.id,
                              child: Text(chart.title.isNotEmpty ? chart.title : 'ì°¨íŠ¸ ${chart.id}'),
                            )),
                          ],
                          onChanged: (String? value) {
                            setState(() {
                              _selectedChartId = value;
                            });
                          },
                        );
                      },
                    ),
                    const SizedBox(width: 12),
                    // ì •ë ¬ ë“œë¡­ë‹¤ìš´
                    PopupMenuButton<String>(
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                        decoration: BoxDecoration(
                          color: const Color(0xFFFF8A65),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              _selectedSort,
                              style: const TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.w600,
                                fontSize: 14,
                              ),
                            ),
                            const SizedBox(width: 4),
                            const Icon(
                              Icons.arrow_drop_down,
                              color: Colors.white,
                              size: 20,
                            ),
                          ],
                        ),
                      ),
                      itemBuilder: (context) => [
                        ..._customSortOptions.map((option) => PopupMenuItem<String>(
                          value: option,
                          child: Text(option),
                        )),
                        const PopupMenuDivider(),
                        PopupMenuItem<String>(
                          value: 'ADD_NEW',
                          child: Row(
                            children: [
                              const Icon(Icons.add, size: 20),
                              const SizedBox(width: 8),
                              const Text('ìƒˆ ì •ë ¬ ë°©ì‹ ì¶”ê°€'),
                            ],
                          ),
                        ),
                      ],
                      onSelected: (String value) {
                        if (value == 'ADD_NEW') {
                          _showAddSortOptionDialog();
                        } else {
                          setState(() {
                            _selectedSort = value;
                          });
                        }
                      },
                    ),
                  ],
                ),
              ],
            ),
          ),
          // ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ (ì°¨íŠ¸ ë°ì´í„° ê¸°ë°˜)
          Expanded(
            child: Consumer(
              builder: (context, ref, child) {
                final chartList = ref.watch(propertyChartListProvider);
                final propertyList = <PropertyData>[];

                // ì„ íƒëœ ì°¨íŠ¸ì— ë”°ë¼ í•„í„°ë§
                if (_selectedChartId != null) {
                  final selectedChart = chartList.firstWhere(
                    (chart) => chart.id == _selectedChartId,
                    orElse: () => PropertyChartModel(
                      id: '',
                      title: '',
                      date: DateTime.now(),
                      properties: [],
                    ),
                  );
                  propertyList.addAll(selectedChart.properties);
                } else {
                  // ëª¨ë“  ì°¨íŠ¸ì˜ ë¶€ë™ì‚° ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë¦¬ìŠ¤íŠ¸ë¡œ í•©ì¹˜ê¸°
                  for (final chart in chartList) {
                    propertyList.addAll(chart.properties);
                  }
                }

                // ì„ íƒëœ ì •ë ¬ ë°©ì‹ì— ë”°ë¼ ì •ë ¬
                _sortPropertyList(propertyList);

                if (propertyList.isEmpty) {
                  return _buildEmptyState();
                }
                return _buildCardList(propertyList, chartList);
              },
            ),
          ),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          if (userId != null) {
            _showAddCardDialog(context, ref, userId);
          }
        },
        backgroundColor: const Color(0xFFFF8A65),
        child: const Icon(Icons.add, color: Colors.white),
      ),
    );
  }

  Widget _buildFilterChip(String label, bool isSelected) {
    return GestureDetector(
      onTap: () {
        setState(() {
          _selectedSort = label;
        });
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? const Color(0xFFFF8A65) : Colors.grey[100],
          borderRadius: BorderRadius.circular(20),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: isSelected ? Colors.white : Colors.grey[600],
            fontWeight: isSelected ? FontWeight.w600 : FontWeight.normal,
            fontSize: 14,
          ),
        ),
      ),
    );
  }

  Widget _buildAddFilterButton() {
    return GestureDetector(
      onTap: _showAddSortOptionDialog,
      child: Container(
        width: 36,
        height: 36,
        decoration: BoxDecoration(
          color: Colors.grey[100],
          borderRadius: BorderRadius.circular(18),
        ),
        child: const Icon(Icons.add, color: Colors.grey, size: 20),
      ),
    );
  }

  void _showAddSortOptionDialog() {
    final controller = TextEditingController();
    showDialog(
      context: context,
      builder: (ctx) {
        return AlertDialog(
          title: const Text('ì •ë ¬ ì˜µì…˜ ì¶”ê°€'),
          content: TextField(
            controller: controller,
            decoration: const InputDecoration(
              labelText: 'ì •ë ¬ ë°©ì‹ ì´ë¦„',
              hintText: 'ì˜ˆ: ë³„ì ìˆœ, ë°©í–¥ìˆœ ë“±',
            ),
          ),
          actions: [
            TextButton(
              child: const Text('ì·¨ì†Œ'),
              onPressed: () => Navigator.of(ctx).pop(),
            ),
            TextButton(
              child: const Text('ì¶”ê°€'),
              onPressed: () {
                if (controller.text.trim().isNotEmpty) {
                  setState(() {
                    _customSortOptions.add(controller.text.trim());
                  });
                  Navigator.of(ctx).pop();
                }
              },
            ),
          ],
        );
      },
    );
  }

  void _sortPropertyList(List<PropertyData> properties) {
    switch (_selectedSort) {
      case 'ìµœì‹ ìˆœ':
        // IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìµœì‹ ìˆœ ì •ë ¬ (IDê°€ timestamp ê¸°ë°˜ì´ë¯€ë¡œ)
        properties.sort((a, b) => b.id.compareTo(a.id));
        break;
      case 'ê±°ë¦¬ìˆœ':
        // ê±°ë¦¬ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬ (ì¶”í›„ ê±°ë¦¬ í•„ë“œ ì¶”ê°€ ê°€ëŠ¥)
        properties.sort((a, b) => a.name.compareTo(b.name));
        break;
      case 'ì›”ì„¸ìˆœ':
        // ì›”ì„¸ë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ì •ë ¬ (ë‚®ì€ ê¸ˆì•¡ë¶€í„°)
        properties.sort((a, b) {
          final rentA = _extractNumberFromString(a.rent);
          final rentB = _extractNumberFromString(b.rent);
          return rentA.compareTo(rentB);
        });
        break;
      case 'ë³„ì ìˆœ':
        // ë³„ì  ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
        properties.sort((a, b) => b.rating.compareTo(a.rating));
        break;
      case 'ë³´ì¦ê¸ˆìˆœ':
        // ë³´ì¦ê¸ˆì„ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ì •ë ¬ (ë‚®ì€ ê¸ˆì•¡ë¶€í„°)
        properties.sort((a, b) {
          final depositA = _extractNumberFromString(a.deposit);
          final depositB = _extractNumberFromString(b.deposit);
          return depositA.compareTo(depositB);
        });
        break;
      case 'ì´ë¦„ìˆœ':
        // ì´ë¦„ ê°€ë‚˜ë‹¤ ìˆœìœ¼ë¡œ ì •ë ¬
        properties.sort((a, b) => a.name.compareTo(b.name));
        break;
      default:
        // ì‚¬ìš©ì ì •ì˜ ì •ë ¬ ì˜µì…˜ ì²˜ë¦¬
        if (_selectedSort.contains('ìˆœ')) {
          final sortField = _selectedSort.replaceAll('ìˆœ', '');
          properties.sort((a, b) {
            final valueA = _getPropertyValueForPriority(sortField, a) ?? '';
            final valueB = _getPropertyValueForPriority(sortField, b) ?? '';
            return valueA.compareTo(valueB);
          });
        }
        break;
    }
  }

  int _extractNumberFromString(String text) {
    // ë¬¸ìì—´ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ (ì˜ˆ: "50ë§Œì›" -> 50)
    final regex = RegExp(r'\d+');
    final match = regex.firstMatch(text);
    if (match != null) {
      return int.tryParse(match.group(0)!) ?? 0;
    }
    return 0;
  }

  Widget _buildEmptyState() {
    return const Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.credit_card_outlined, size: 64, color: Colors.grey),
          SizedBox(height: 16),
          Text('ë“±ë¡ëœ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.',
              style: TextStyle(fontSize: 16, color: Colors.grey)),
          SizedBox(height: 8),
          Text('ì²« ë²ˆì§¸ ì¹´ë“œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!',
              style: TextStyle(fontSize: 14, color: Colors.grey)),
        ],
      ),
    );
  }

  Widget _buildCardList(List<PropertyData> properties, List<PropertyChartModel> chartList) {
    return ListView.builder(
      padding: const EdgeInsets.all(16),
      itemCount: properties.length,
      itemBuilder: (context, index) {
        final property = properties[index];
        return _buildCardItem(property, chartList);
      },
    );
  }

  Widget _buildCardItem(PropertyData property, List<PropertyChartModel> chartList) {
    return Consumer(
      builder: (context, ref, child) {
        final userPriorities = ref.watch(userPrioritiesProvider);
        
        return GestureDetector(
          onTap: () {
            // ìƒì„¸ í™”ë©´ìœ¼ë¡œ ì´ë™
            context.goNamed(PropertyDetailScreen.routeName);
          },
          child: Container(
        margin: const EdgeInsets.only(bottom: 16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.08),
              blurRadius: 8,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // ìƒë‹¨ í—¤ë” (ì œëª©, ë³„ì , ì´ë¯¸ì§€)
            Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          property.name.isNotEmpty
                              ? property.name
                              : 'ë¶€ë™ì‚° ${property.order}',
                          style: const TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.w600,
                            color: Colors.black87,
                          ),
                        ),
                        const SizedBox(height: 8),
                        if (property.rating > 0) ...[
                          Row(
                            children: List.generate(5, (starIndex) {
                              return Icon(
                                starIndex < property.rating
                                    ? Icons.star
                                    : Icons.star_border,
                                color: Colors.amber,
                                size: 20,
                              );
                            }),
                          ),
                          const SizedBox(height: 8),
                        ],
                        // ì‚¬ìš©ì ìš°ì„ ìˆœìœ„ ì •ë³´ í‘œì‹œ
                        if (userPriorities.isNotEmpty) ...[
                          _buildPriorityTags(userPriorities, property, chartList),
                          const SizedBox(height: 8),
                        ],
                        if (property.rent.isNotEmpty ||
                            property.deposit.isNotEmpty) ...[
                          Text(
                            'ì›”ì„¸: ${property.rent.isNotEmpty ? property.rent : '-'} | ë³´ì¦ê¸ˆ: ${property.deposit.isNotEmpty ? property.deposit : '-'}',
                            style: const TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w500,
                              color: Colors.black87,
                            ),
                          ),
                          const SizedBox(height: 8),
                        ],
                        if (property.direction.isNotEmpty ||
                            property.landlordEnvironment.isNotEmpty)
                          Text(
                            [
                              if (property.direction.isNotEmpty)
                                'ë°©í–¥: ${property.direction}',
                              if (property.landlordEnvironment.isNotEmpty)
                                'í™˜ê²½: ${property.landlordEnvironment}',
                            ].join(' | '),
                            style: TextStyle(
                              fontSize: 14,
                              color: Colors.grey[600],
                            ),
                          ),
                      ],
                    ),
                  ),
                  const SizedBox(width: 16),
                  // ì´ë¯¸ì§€ í”Œë ˆì´ìŠ¤í™€ë”
                  Container(
                    width: 100,
                    height: 100,
                    decoration: BoxDecoration(
                      color: Colors.grey[200],
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Icon(
                      Icons.home,
                      color: Colors.grey[400],
                      size: 38,
                    ),
                  ),
                ],
              ),
            ),
            // í•˜ë‹¨ ìˆœë²ˆ í‘œì‹œ
            if (property.order.isNotEmpty)
              Padding(
                padding: const EdgeInsets.fromLTRB(16, 0, 16, 16),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: Colors.grey[100],
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Text(
                        'ìˆœë²ˆ: ${property.order}',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey[600],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
          ],
        ),
      ),
    );
      },
    );
  }

  // ìš°ì„ ìˆœìœ„ íƒœê·¸ë“¤ì„ í‘œì‹œí•˜ëŠ” ìœ„ì ¯ (ì²´í¬ëœ í•­ëª©ë§Œ)
  Widget _buildPriorityTags(List<String> userPriorities, PropertyData property, List<PropertyChartModel> chartList) {
    // ì‹¤ì‹œê°„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ Consumer ì‚¬ìš©
    return Consumer(
      builder: (context, ref, child) {
        final userAsync = ref.watch(userModelProvider);
        final realtimeChartList = ref.watch(propertyChartListProvider);
    
    return userAsync.when(
      data: (user) {
        // ì²´í¬ëœ(ë³´ì´ê¸° ì„¤ì •ëœ) ìš°ì„ ìˆœìœ„ë§Œ í•„í„°ë§
        List<String> visiblePriorities = [];
        
        if (user?.priorityItems.isNotEmpty == true) {
          // ìƒˆë¡œìš´ êµ¬ì¡°í™”ëœ ë°ì´í„° ì‚¬ìš©
          visiblePriorities = user!.priorityItems
              .where((item) => item.isVisible)
              .map((item) => item.name)
              .toList();
        } else {
          // ê¸°ì¡´ ë°ì´í„° êµ¬ì¡° í˜¸í™˜ì„±
          visiblePriorities = userPriorities;
        }

        // í˜„ì¬ propertyê°€ ì†í•œ ì°¨íŠ¸ ì°¾ê¸°
        PropertyChartModel? currentChart;
        for (var chart in chartList) {
          if (chart.properties.any((p) => p.id == property.id)) {
            currentChart = chart;
            break;
          }
        }
        
        // ì°¨íŠ¸ì—ì„œë„ í‘œì‹œë˜ë„ë¡ ì„¤ì •ëœ ì»¬ëŸ¼ë§Œ í•„í„°ë§
        if (currentChart?.columnVisibility != null && currentChart!.columnVisibility!.isNotEmpty) {
          print('ğŸ” ì°¨íŠ¸ ì»¬ëŸ¼ í‘œì‹œ ì„¤ì •: ${currentChart.columnVisibility}');
          final originalCount = visiblePriorities.length;
          visiblePriorities = visiblePriorities.where((priority) {
            String mappedColumn = _mapPriorityToColumn(priority);
            bool isVisible = currentChart!.columnVisibility![mappedColumn] ?? false;
            print('ğŸ” ìš°ì„ ìˆœìœ„: $priority -> ì»¬ëŸ¼: $mappedColumn -> í‘œì‹œ: $isVisible');
            return isVisible;
          }).toList();
          print('ğŸ” í•„í„°ë§ ê²°ê³¼: $originalCount -> ${visiblePriorities.length} í•­ëª©');
        } else {
          // columnVisibilityê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ëª¨ë“  ìš°ì„ ìˆœìœ„ í‘œì‹œ
          print('ğŸ” ì°¨íŠ¸ì— ì»¬ëŸ¼ í‘œì‹œ ì„¤ì •ì´ ì—†ìŒ, ëª¨ë“  ìš°ì„ ìˆœìœ„ í‘œì‹œ');
        }
        
        // ì‹¤ì‹œê°„ ì°¨íŠ¸ ëª©ë¡ì—ì„œ í˜„ì¬ propertyê°€ ì†í•œ ì°¨íŠ¸ ì°¾ê¸°
        PropertyChartModel? currentChart;
        for (var chart in realtimeChartList) {
          if (chart.properties.any((p) => p.id == property.id)) {
            currentChart = chart;
            break;
          }
        }

        List<Widget> tags = [];
        Set<String> addedTags = {}; // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ Set
        
        // ê³ ì • í•­ëª©ë“¤ ì •ì˜ (ì¹´ë“œ ìƒë‹¨ì— ì´ë¯¸ í‘œì‹œë˜ë¯€ë¡œ íƒœê·¸ì—ì„œ ì œì™¸)
        const fixedItems = {'ì§‘ ì´ë¦„', 'ì›”ì„¸', 'ë³´ì¦ê¸ˆ', 'ìˆœ'};
        
        // ì°¨íŠ¸ì—ì„œ í‘œì‹œí•˜ë„ë¡ ì„¤ì •ëœ ì»¬ëŸ¼ë“¤ë§Œ íƒœê·¸ë¡œ í‘œì‹œ
        if (currentChart?.columnVisibility != null && currentChart!.columnVisibility!.isNotEmpty) {
          final visibleColumns = currentChart.columnVisibility!.entries
              .where((entry) => entry.value == true)
              .map((entry) => entry.key)
              .where((column) => !fixedItems.contains(column)) // ê³ ì • í•­ëª©ë“¤ ì œì™¸
              .take(8) // ìµœëŒ€ 8ê°œê¹Œì§€ í‘œì‹œ
              .toList();
          
          for (String column in visibleColumns) {
            if (addedTags.contains(column)) continue; // ì¤‘ë³µ ë°©ì§€
            
            String? value = _getColumnValueForProperty(column, property);
            if (value != null && value.isNotEmpty && value != '-') {
              addedTags.add(column);
              tags.add(
                Container(
                  margin: const EdgeInsets.only(right: 6, bottom: 4),
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                  decoration: BoxDecoration(
                    color: Colors.grey[100],
                    borderRadius: BorderRadius.circular(6),
                    border: Border.all(
                      color: Colors.grey[300]!,
                      width: 1,
                    ),
                  ),
                  child: Text(
                    '$column: $value',
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[700],
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
              );
            }
          }
        }
        
        if (tags.isEmpty) return const SizedBox.shrink();
        
        return Wrap(
          children: tags,
        );
      },
    );
  }

  // ì»¬ëŸ¼ëª…ì— ë”°ë¼ í•´ë‹¹í•˜ëŠ” ë¶€ë™ì‚° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í—¬í¼ ë©”ì„œë“œ (ì°¨íŠ¸ ì»¬ëŸ¼ ê¸°ì¤€)
  String? _getColumnValueForProperty(String columnName, PropertyData property) {
    switch (columnName) {
      case 'ì§‘ ì´ë¦„':
        return property.name.isNotEmpty ? property.name : 'ë¶€ë™ì‚° ${property.order}';
      case 'ë³´ì¦ê¸ˆ':
        return property.deposit;
      case 'ì›”ì„¸':
        return property.rent;
      case 'ì¬ê³„/ë°©í–¥':
        return property.direction;
      case 'ì§‘ì£¼ì¸ í™˜ê²½':
        return property.landlordEnvironment;
      case 'ë³„ì ':
        return property.rating > 0 ? property.rating.toString() : null;
      case 'ì£¼ê±°í˜•íƒœ':
      case 'ê±´ì¶•ë¬¼ìš©ë„':
      case 'ì„ì°¨ê¶Œ ë“±ê¸°ëª…ë ¹ ì´ë ¥ì—¬ë¶€':
      case 'ìˆ˜ë„ ìˆ˜ë‚©':
      case 'ê³µê´‘ë¹„':
      case 'ì¬ì‚°/ë°©í™”':
      case 'ì†ŒìŒ':
      case 'í¸ì˜ì ':
      default:
        // additionalDataì—ì„œ ì»¬ëŸ¼ì— í•´ë‹¹í•˜ëŠ” ê°’ ì°¾ê¸°
        // ì»¬ëŸ¼ ì¸ë±ìŠ¤ë¥¼ í†µí•´ ë°ì´í„° í‚¤ë¥¼ ì°¾ì•„ì•¼ í•¨
        return _getAdditionalDataByColumnName(columnName, property);
    }
  }

  // ì»¬ëŸ¼ëª…ì„ í†µí•´ additionalDataì—ì„œ ê°’ì„ ì°¾ëŠ” í—¬í¼ ë©”ì„œë“œ
  String? _getAdditionalDataByColumnName(String columnName, PropertyData property) {
    // ê¸°ë³¸ ì»¬ëŸ¼ë“¤ì˜ ì¸ë±ìŠ¤ ë§¤í•‘
    const columnIndexMap = {
      'ì§‘ ì´ë¦„': 1,
      'ë³´ì¦ê¸ˆ': 2, 
      'ì›”ì„¸': 3,
      'ì£¼ê±°í˜•íƒœ': 4,
      'ê±´ì¶•ë¬¼ìš©ë„': 5,
      'ì„ì°¨ê¶Œ ë“±ê¸°ëª…ë ¹ ì´ë ¥ì—¬ë¶€': 6,
      'ì¬ê³„/ë°©í–¥': 7,
      'ì§‘ì£¼ì¸ í™˜ê²½': 8,
      'ë³„ì ': 9,
      'ìˆ˜ë„ ìˆ˜ë‚©': 10,
      'ê³µê´‘ë¹„': 11,
      'ì¬ì‚°/ë°©í™”': 12,
      'ì†ŒìŒ': 13,
      'í¸ì˜ì ': 14,
    };
    
    final columnIndex = columnIndexMap[columnName];
    if (columnIndex != null && columnIndex >= 7) {
      // additionalDataëŠ” 7ë²ˆ ì¸ë±ìŠ¤ë¶€í„° ì‹œì‘ (col_7, col_8, ...)
      final dataKey = 'col_$columnIndex';
      return property.additionalData[dataKey];
    }
    
    // ë™ì ìœ¼ë¡œ ì¶”ê°€ëœ ì»¬ëŸ¼ì˜ ê²½ìš° ì»¬ëŸ¼ëª…ìœ¼ë¡œ ì§ì ‘ ì°¾ê¸°
    return property.additionalData[columnName];
  }

  // ìš°ì„ ìˆœìœ„ ì´ë¦„ì— ë”°ë¼ í•´ë‹¹í•˜ëŠ” ë¶€ë™ì‚° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í—¬í¼ ë©”ì„œë“œ (ê¸°ì¡´ í˜¸í™˜ì„±ìš©)
  String? _getPropertyValueForPriority(String priority, PropertyData property) {
    switch (priority) {
      case 'ì›”ì„¸':
      case 'ì›”ì„¸ë¹„ìš©':
        return property.rent;
      case 'ë³´ì¦ê¸ˆ':
        return property.deposit;
      case 'ë°©í–¥':
      case 'ì¬ê³„/ë°©í–¥':
        return property.direction;
      case 'ì§‘ì£¼ì¸ í™˜ê²½':
      case 'í™˜ê²½':
        return property.landlordEnvironment;
      case 'ë³„ì ':
      case 'í‰ì ':
        return property.rating > 0 ? property.rating.toString() : null;
      case 'ì§‘ ì´ë¦„':
      case 'ì´ë¦„':
        return property.name;
      default:
        // ì¶”ê°€ ë°ì´í„°ì—ì„œ ì°¾ê¸°
        return property.additionalData[priority];
    }
  }

  // ìš°ì„ ìˆœìœ„ ì´ë¦„ì„ ì°¨íŠ¸ ì»¬ëŸ¼ëª…ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” í—¬í¼ ë©”ì„œë“œ
  String _mapPriorityToColumn(String priority) {
    switch (priority) {
      case 'ì›”ì„¸':
      case 'ì›”ì„¸ë¹„ìš©':
        return 'ì›”ì„¸';
      case 'ë³´ì¦ê¸ˆ':
        return 'ë³´ì¦ê¸ˆ';
      case 'ë°©í–¥':
      case 'ì¬ê³„/ë°©í–¥':
        return 'ì¬ê³„/ë°©í–¥';
      case 'ì§‘ì£¼ì¸ í™˜ê²½':
      case 'í™˜ê²½':
        return 'ì§‘ì£¼ì¸ í™˜ê²½';
      case 'ë³„ì ':
      case 'í‰ì ':
        return 'ë³„ì ';
      case 'ì§‘ ì´ë¦„':
      case 'ì´ë¦„':
        return 'ì§‘ ì´ë¦„';
      case 'ìˆ˜ë„ ìˆ˜ë‚©':
        return 'ìˆ˜ë„ ìˆ˜ë‚©';
      case 'ê³µê´‘ë¹„':
        return 'ê³µê´‘ë¹„';
      case 'ì¬ì‚°/ë°©í™”':
        return 'ì¬ì‚°/ë°©í™”';
      case 'ì†ŒìŒ':
        return 'ì†ŒìŒ';
      case 'í¸ì˜ì ':
        return 'í¸ì˜ì ';
      default:
        return priority; // ê¸°ë³¸ì ìœ¼ë¡œëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜
    }
  }

  void _showAddCardDialog(BuildContext context, WidgetRef ref, String userId) {
    final nameController = TextEditingController();
    final companyController = TextEditingController();
    final lastFourController = TextEditingController();
    final typeController = TextEditingController(text: 'credit');

    showDialog(
      context: context,
      builder: (ctx) {
        return AlertDialog(
          title: const Text('ìƒˆ ë¶€ë™ì‚° ì¶”ê°€'),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(
                    controller: nameController,
                    decoration: const InputDecoration(labelText: 'ë¶€ë™ì‚° ì´ë¦„')),
                TextField(
                    controller: companyController,
                    decoration: const InputDecoration(labelText: 'ìœ„ì¹˜')),
                TextField(
                  controller: lastFourController,
                  decoration: const InputDecoration(labelText: 'ì›”ì„¸ ê¸ˆì•¡'),
                  keyboardType: TextInputType.number,
                ),
                TextField(
                    controller: typeController,
                    decoration: const InputDecoration(labelText: 'ë¶€ë™ì‚° ì¢…ë¥˜')),
              ],
            ),
          ),
          actions: [
            TextButton(
                child: const Text('ì·¨ì†Œ'),
                onPressed: () => Navigator.of(ctx).pop()),
            TextButton(
              child: const Text('ì¶”ê°€'),
              onPressed: () {
                final newCard = CardModel(
                  id: '',
                  userId: userId,
                  name: nameController.text,
                  company: companyController.text,
                  numberLastFour: lastFourController.text,
                  type: typeController.text,
                  benefits: [],
                );
                ref.read(cardListViewModelProvider.notifier).addCard(newCard);
                Navigator.of(ctx).pop();
              },
            ),
          ],
        );
      },
    );
  }
}
